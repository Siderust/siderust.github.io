---
import BaseLayout from '../../layouts/BaseLayout.astro';
import ProjectCard from '../../components/ProjectCard.astro';
import Icon from '../../components/Icon.astro';
import { getProjects } from '../../lib/projects';

const projects = await getProjects();
const languages = Array.from(
  new Set(projects.map((project) => project.language).filter(Boolean)),
).sort();
---

<BaseLayout title="Projects" description="Explore Siderust crates with live metadata, releases, and documentation links.">
  <section class="section">
    <div class="mx-auto w-full max-w-6xl px-6">
      <div class="flex flex-col gap-4 sm:flex-row sm:items-end sm:justify-between">
        <div>
          <p class="text-xs font-semibold uppercase tracking-[0.2em] text-blue-500/80 dark:text-blue-300/80">
            Projects
          </p>
          <h1 class="mt-2 text-3xl font-semibold text-slate-900 dark:text-white">All Siderust projects</h1>
          <p class="mt-3 max-w-2xl text-sm text-slate-600 dark:text-slate-300">
            Filter by language, docs availability, and release cadence. Sort by popularity or recent activity.
          </p>
        </div>
        <div class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-4 py-2 text-xs font-semibold text-slate-600 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200">
          <Icon name="database" class="h-4 w-4" />
          <span data-project-count aria-live="polite">{projects.length} projects</span>
        </div>
      </div>

      <div class="mt-10 grid gap-4 rounded-2xl border border-slate-200 bg-white/70 p-4 dark:border-slate-800 dark:bg-slate-900/50 md:grid-cols-4">
        <label class="flex flex-col gap-2 text-xs font-semibold uppercase tracking-[0.1em] text-slate-500 dark:text-slate-300">
          Search
          <div class="flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-medium text-slate-600 dark:border-slate-800 dark:bg-slate-950 dark:text-slate-200">
            <Icon name="search" class="h-4 w-4" />
            <input
              id="project-search"
              class="w-full bg-transparent text-sm outline-none placeholder:text-slate-400 dark:placeholder:text-slate-500"
              type="search"
              placeholder="Search projects..."
            />
          </div>
        </label>
        <label class="flex flex-col gap-2 text-xs font-semibold uppercase tracking-[0.1em] text-slate-500 dark:text-slate-300">
          Language
          <select
            id="project-language"
            class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-medium text-slate-600 outline-none dark:border-slate-800 dark:bg-slate-950 dark:text-slate-200"
          >
            <option value="all">All</option>
            {languages.map((language) => (
              <option value={language}>{language}</option>
            ))}
          </select>
        </label>
        <label class="flex flex-col gap-2 text-xs font-semibold uppercase tracking-[0.1em] text-slate-500 dark:text-slate-300">
          Filters
          <div class="flex flex-col gap-2 rounded-xl border border-slate-200 bg-white px-3 py-3 text-sm font-medium text-slate-600 dark:border-slate-800 dark:bg-slate-950 dark:text-slate-200">
            <label class="inline-flex items-center gap-2">
              <input class="accent-blue-600" type="checkbox" id="filter-docs" />
              Has docs
            </label>
            <label class="inline-flex items-center gap-2">
              <input class="accent-blue-600" type="checkbox" id="filter-release" />
              Has releases
            </label>
          </div>
        </label>
        <label class="flex flex-col gap-2 text-xs font-semibold uppercase tracking-[0.1em] text-slate-500 dark:text-slate-300">
          Sort by
          <select
            id="project-sort"
            class="rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-medium text-slate-600 outline-none dark:border-slate-800 dark:bg-slate-950 dark:text-slate-200"
          >
            <option value="stars">Stars</option>
            <option value="updated">Last updated</option>
            <option value="name">Name</option>
          </select>
        </label>
      </div>

      <div class="mt-10 grid gap-6 lg:grid-cols-3" data-project-grid>
        {projects.map((project) => (
          <ProjectCard
            project={project}
            dataAttrs={{
              'data-project-card': 'true',
              'data-name': project.displayName.toLowerCase(),
              'data-description': project.description.toLowerCase(),
              'data-language': project.language,
              'data-stars': project.stars,
              'data-updated': new Date(project.updatedAt).getTime(),
              'data-has-docs': project.docsUrl ? 'true' : 'false',
              'data-has-release': project.latestRelease ? 'true' : 'false',
            }}
          />
        ))}
      </div>
    </div>
  </section>

  <script is:inline>
    (() => {
      const grid = document.querySelector('[data-project-grid]');
      const cards = Array.from(document.querySelectorAll('[data-project-card]'));
      const count = document.querySelector('[data-project-count]');

      const search = document.getElementById('project-search');
      const language = document.getElementById('project-language');
      const filterDocs = document.getElementById('filter-docs');
      const filterRelease = document.getElementById('filter-release');
      const sort = document.getElementById('project-sort');

      if (!grid || !search || !language || !filterDocs || !filterRelease || !sort) return;

      const items = cards.map((card) => ({
        element: card,
        name: card.dataset.name ?? '',
        description: card.dataset.description ?? '',
        language: card.dataset.language ?? '',
        stars: Number(card.dataset.stars ?? 0),
        updated: Number(card.dataset.updated ?? 0),
        hasDocs: card.dataset.hasDocs === 'true',
        hasRelease: card.dataset.hasRelease === 'true',
      }));

      const apply = () => {
        const query = search.value.trim().toLowerCase();
        const lang = language.value;
        const requireDocs = filterDocs.checked;
        const requireRelease = filterRelease.checked;
        const sortBy = sort.value;

        const visible = items.filter((item) => {
          const matchesQuery = !query || item.name.includes(query) || item.description.includes(query);
          const matchesLanguage = lang === 'all' || item.language === lang;
          const matchesDocs = !requireDocs || item.hasDocs;
          const matchesRelease = !requireRelease || item.hasRelease;
          return matchesQuery && matchesLanguage && matchesDocs && matchesRelease;
        });

        const sorted = visible.sort((a, b) => {
          if (sortBy === 'updated') return b.updated - a.updated;
          if (sortBy === 'name') return a.name.localeCompare(b.name);
          return b.stars - a.stars;
        });

        items.forEach((item) => {
          item.element.hidden = !visible.includes(item);
        });

        sorted.forEach((item) => {
          grid.appendChild(item.element);
        });

        if (count) {
          count.textContent = `${visible.length} project${visible.length === 1 ? '' : 's'}`;
        }
      };

      ['input', 'change'].forEach((eventName) => {
        search.addEventListener(eventName, apply);
        language.addEventListener(eventName, apply);
        filterDocs.addEventListener(eventName, apply);
        filterRelease.addEventListener(eventName, apply);
        sort.addEventListener(eventName, apply);
      });

      apply();
    })();
  </script>
</BaseLayout>
